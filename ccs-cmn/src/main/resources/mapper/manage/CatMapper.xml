<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ccs.cmn.mapper.manage.CatMapper">
<!-- 고양이 관리 페이지 -->

	<!-- 고양이 목록 조회 -->
	<select id="selectCatList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.CAT_CD  
			, C.GROUP_YN
			, N.CAT_NAME
			, CASE WHEN C.GROUP_YN = 'N' 
				THEN COALESCE(FN_GET_CODE_NAME('C0003', P.CATKIND_CD), '알수없음')
				ELSE '무리' END												AS CAT_KIND_NM
			, COALESCE(FN_GET_AREA_NAME(C.SIDO_CD), '') 		|| ' ' ||
				COALESCE(FN_GET_AREA_NAME(C.SIGUNGU_CD), '') 	|| ' ' || 
				COALESCE(FN_GET_AREA_NAME(C.DONG_CD), '')        			AS AREA_NM
			, F.FILE_PATH 
		FROM TB_CAT C
			LEFT JOIN TB_CAT_PROFILE P
				ON C.CAT_CD = P.CAT_CD
			LEFT JOIN TB_CAT_GRP_PROFILE G
				ON C.CAT_CD = G.CAT_CD 
			LEFT JOIN TB_FILE F 
				ON (P.FILE_GRP_ID = F.FILE_GRP_ID OR G.FILE_GRP_ID = F.FILE_GRP_ID )
			LEFT JOIN TB_CAT_NAME N
				ON (C.CAT_CD = N.CAT_CD AND N.USER_CD = 1)
		<where>
			<if test="sido_cd != null and !sido_cd.equals('')">
				C.SIDO_CD = #{sido_cd}
			</if>
			<if test="sigungu_cd != null and !sigungu_cd.equals('')">
				AND C.SIGUNGU_CD = #{sigungu_cd}
			</if>
			<if test="dong_cd != null and !dong_cd.equals('')">
				AND C.DONG_CD = #{dong_cd}
			</if>
			<if test="cat_cd != null and !cat_cd.equals('')">
				AND C.CAT_CD = #{cat_cd}
			</if>
			<if test="group_yn != null and !group_yn.equals('')">
				AND C.GROUP_YN = #{group_yn}
			</if>
			<if test="cat_name != null and !cat_name.equals('')">
				AND N.CAT_NAME  like '%'|| #{cat_name} ||'%'
			</if>
			<if test="habitat_cd != null and !habitat_cd.equals('')">
				AND (	SELECT COUNT(*) 
						FROM TB_HABITAT_INFO I 
						WHERE I.HABITAT_CD = #{habitat_cd} 
						AND I.CAT_CD = C.CAT_CD
					) > 0
			</if>
		</where>
		ORDER BY C.CAT_CD DESC
	</select>

	<select id="selectCatByCd" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.CAT_CD  
			, C.GROUP_YN
			, C.SIDO_CD
			, C.SIGUNGU_CD
			, C.DONG_CD 
			, C.USER_CD
			, C.REG_DT 
			, P.CATKIND_CD
			, P.INTRODUCTION
			, P.AGE
			, P.GENDER
			, P.NEUTERING_YN
			, F.FILE_GRP_ID
			, F.FILE_PATH
		FROM TB_CAT C
			LEFT JOIN TB_CAT_PROFILE P
				ON C.CAT_CD = P.CAT_CD
			LEFT JOIN TB_CAT_GRP_PROFILE G
				ON C.CAT_CD = G.CAT_CD 
			LEFT JOIN TB_FILE F 
				ON (P.FILE_GRP_ID = F.FILE_GRP_ID OR G.FILE_GRP_ID = F.FILE_GRP_ID )
		WHERE C.CAT_CD = #{cat_cd}
	</select>
	
	<!-- 무리 고양이에 소속된 고양이 수 -->
	<select id="selectCatGrpMemberCount" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT COUNT(*) 
		FROM TB_CAT_GRP_INFO G
		WHERE G.CAT_GRP_CD = #{cat_cd}
	</select>
	
	<!-- 등록 -->
	<insert id="insertCat" parameterType="java.util.Map" useGeneratedKeys="true" keyColumn="cat_cd" keyProperty="cat_cd">
	    	INSERT INTO TB_CAT
			(
				GROUP_YN
				, SIDO_CD
				, SIGUNGU_CD
				, DONG_CD
				, USER_CD
				, REG_ID
				, REG_DT
				, UPDT_ID
				, UPDT_DT
			)
			VALUES
			(
				#{group_yn}
				, #{sido_cd}
				, #{sigungu_cd}
				, #{dong_cd}
				, #{_SESSION_USER_CD_} -- 입력사용자
				, #{_SESSION_USER_CD_} -- 입력사용자
				, NOW() -- 입력일자
				, #{_SESSION_USER_CD_} -- 변경사용자
				, NOW() -- 변경일자
			)
	</insert>
	
	<insert id="insertCatProfile" parameterType="java.util.Map">
	    	INSERT INTO TB_CAT_PROFILE
			(
				CAT_CD
				, INTRODUCTION
				, CATKIND_CD
				, AGE
				, GENDER
				, NEUTERING_YN
				<if test="file_grp_id != null and !file_grp_id.equals('')">
				, FILE_GRP_ID
				</if>
				, REG_ID
				, REG_DT
				, UPDT_ID
				, UPDT_DT
			)
			VALUES
			(
				#{cat_cd}
				, #{introduction}
				, #{catkind_cd}
				, #{age}
				, #{gender}
				, #{neutering_yn}
				<if test="file_grp_id != null and !file_grp_id.equals('')">
				, #{file_grp_id}
				</if>
				, #{_SESSION_USER_CD_} -- 입력사용자
				, NOW() -- 입력일자
				, #{_SESSION_USER_CD_} -- 변경사용자
				, NOW() -- 변경일자
			)
	</insert>
	
	<insert id="insertCatGrpProfile" parameterType="java.util.Map">
	    	INSERT INTO TB_CAT_GRP_PROFILE
			(
				CAT_CD
				, INTRODUCTION
				<if test="file_grp_id != null and !file_grp_id.equals('')">
				, FILE_GRP_ID
				</if>
				, REG_ID
				, REG_DT
				, UPDT_ID
				, UPDT_DT
			)
			VALUES
			(
				#{cat_cd}
				, #{introduction}
				<if test="file_grp_id != null and !file_grp_id.equals('')">
				, #{file_grp_id}
				</if>
				, #{_SESSION_USER_CD_} -- 입력사용자
				, NOW() -- 입력일자
				, #{_SESSION_USER_CD_} -- 변경사용자
				, NOW() -- 변경일자
			)
	</insert>
	
	<!-- 수정 -->
	<update id="updateCat" parameterType="java.util.Map">
	    	UPDATE TB_CAT
			SET SIDO_CD 		= #{sido_cd}
				, SIGUNGU_CD 	= #{sigungu_cd}
				, DONG_CD 		= #{dong_cd}
				, UPDT_ID 		= #{_SESSION_USER_CD_}
				, UPDT_DT 		= NOW()
			WHERE CAT_CD = #{cat_cd}
	</update>
	
	<update id="updateCatProfile" parameterType="java.util.Map">
	    	UPDATE TB_CAT_PROFILE
			SET INTRODUCTION 	= #{introduction}
				, CATKIND_CD 	= #{catkind_cd}
				, AGE 			= #{age}
				, GENDER 		= #{gender}
				, NEUTERING_YN 	= #{neutering_yn}
				, FILE_GRP_ID 	= #{file_grp_id}
				, UPDT_ID 		= #{_SESSION_USER_CD_}
				, UPDT_DT 		= NOW()
			WHERE CAT_CD = #{cat_cd}
	</update>
	
	<update id="updateCatGrpProfile" parameterType="java.util.Map">
	    	UPDATE TB_CAT_GRP_PROFILE
			SET INTRODUCTION 	= #{introduction}
				, FILE_GRP_ID 	= #{file_grp_id}
				, UPDT_ID 		= #{_SESSION_USER_CD_}
				, UPDT_DT 		= NOW()
			WHERE CAT_CD = #{cat_cd}
	</update>
	
	<!-- 삭제 -->
	<delete id="deleteCat" parameterType="java.util.Map">
	    	DELETE FROM TB_CAT
			WHERE CAT_CD = #{cat_cd}
	</delete>
	
	<delete id="deleteCatProfile" parameterType="java.util.Map">
	    	DELETE FROM TB_CAT_PROFILE
			WHERE CAT_CD = #{cat_cd}
	</delete>
	
	<delete id="deleteCatGrpProfile" parameterType="java.util.Map">
	    	DELETE FROM TB_CAT_GRP_PROFILE
			WHERE CAT_CD = #{cat_cd}
	</delete>
</mapper>