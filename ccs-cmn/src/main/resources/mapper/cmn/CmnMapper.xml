<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ccs.cmn.mapper.CmnMapper">

	<!-- 공통 코드 조회 -->
	<select id="selectCmnCodeList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.CMMN_CD as value
			, C.CMMN_CD_NM as name
			, C.PRNT_CD as prntCode
		FROM TB_CMNCODE C
		<where>
			<if test="code!=null and !code.equals('')">
				C.CMMN_GRP_CD  = #{code}
			</if>
 			<choose>
 				<when test="prntCode!=null and !prntCode.equals('')">
					AND C.PRNT_CD = #{prntCode}		
				</when>
				<when test="prntCode!=null and prntCode == 0">
					AND C.PRNT_CD IS NULL	
				</when>
			</choose>
			<if test="exceptCode!=null and !exceptCode.equals('')">
				AND D.CMMN_CD != #{exceptCode}
			</if>		
		</where>
		ORDER BY C.CMMN_CD_SEQ ASC
	</select>
	
	<!-- 지역 코드 조회 -->
	<select id="selectAreaCodeList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.AREA_CD as value
			, C.AREA_NM as name
			, C.AREA_UPPER_CD as prntCode
		FROM TB_AREA C
		<where>			
			<if test="code!=null and !code.equals('')">
				C.AREA_GRP_CD = #{code}
			</if>
			<if test="prntCode!=null and !prntCode.equals('')">
				AND C.AREA_UPPER_CD = #{prntCode}		
			</if>
		</where>
		ORDER BY C.AREA_CD_SEQ ASC
	</select>
	
	
	<!-- 고양이 지역 조회 -->
	<select id="selectCatArea" parameterType="java.lang.Long" resultType="java.util.Map">
		SELECT  C.SIDO_CD
				, C.SIGUNGU_CD
				, C.DONG_CD
				, fn_get_area_name(C.SIDO_CD)			AS SIDO_NM
				, fn_get_area_name(C.SIGUNGU_CD)        AS SIGUNGU_NM
				, fn_get_area_name(C.DONG_CD)           AS DONG_NM
		FROM TB_CAT C
		WHERE C.CAT_CD = #{target_cd}
	</select>
	
	<!-- 고양이 무리 여부 조회 -->
	<select id="selectCatGroupYn" parameterType="java.lang.Long" resultType="java.lang.String">
		SELECT  C.GROUP_YN
		FROM TB_CAT C
		WHERE C.CAT_CD = #{item}
	</select>
	
	<!-- 고양이 검색  -->
	<select id="selectSearchCatList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.CAT_CD
			, C.GROUP_YN
			, COALESCE(FN_GET_AREA_NAME(C.SIDO_CD), '') 		|| ' ' ||
				COALESCE(FN_GET_AREA_NAME(C.SIGUNGU_CD), '') 	|| ' ' || 
				COALESCE(FN_GET_AREA_NAME(C.DONG_CD), '')                   AS AREA_NM
			, FN_GET_CODE_NAME('C0003', P.CATKIND_CD) 						AS CAT_KIND_NM
			, F.FILE_PATH
			, N.CAT_NAME
		FROM TB_CAT C 
			LEFT JOIN TB_CAT_PROFILE P 
				ON C.CAT_CD  = P.CAT_CD
			LEFT JOIN TB_FILE F
				ON P.FILE_GRP_ID = F.FILE_GRP_ID
			LEFT JOIN TB_CAT_NAME N
				ON C.CAT_CD = N.CAT_CD
					AND N.USER_CD = #{_SESSION_USER_CD_}
		<where>
			<if test="group_yn != null and !group_yn.equals('')">
				C.GROUP_YN = #{group_yn}
			</if>
			<if test="sido_cd != null and !sido_cd.equals('')">
				AND C.SIDO_CD = #{sido_cd}
			</if>
			<if test="sigungu_cd != null and !sigungu_cd.equals('')">
				AND C.SIGUNGU_CD = #{sigungu_cd}
			</if>
			<if test="dong_cd != null and !dong_cd.equals('')">
				AND C.DONG_CD = #{dong_cd}
			</if>
			<if test="cat_cd != null and !cat_cd.equals('')">
				AND C.CAT_CD = #{cat_cd}
			</if>
			<if test="cat_name != null and !cat_name.equals('')">
				AND N.CAT_NAME like '%'|| #{cat_name} ||'%'
			</if>
		</where>
		ORDER BY C.CAT_CD DESC
	</select>
	
	<!-- 서식지 검색  -->
	<select id="selectSearchHabitatList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT H.HABITAT_CD 
			, H.HABITAT_NM
			, FN_GET_AREA_NAME(H.SIDO_CD) || ' ' ||
				FN_GET_AREA_NAME(H.SIGUNGU_CD) || ' ' || 
				FN_GET_AREA_NAME(H.DONG_CD)                     AS AREA_NM
			, H.ADDRESS
			, F.FILE_PATH 
		FROM TB_HABITAT H 
			LEFT JOIN TB_FILE F 
				ON H.FILE_GRP_ID = F.FILE_GRP_ID 
		<where>
			<if test="sido_cd != null and !sido_cd.equals('')">
				H.SIDO_CD = #{sido_cd}
			</if>
			<if test="sigungu_cd != null and !sigungu_cd.equals('')">
				AND H.SIGUNGU_CD = #{sigungu_cd}
			</if>
			<if test="dong_cd != null and !dong_cd.equals('')">
				AND H.DONG_CD = #{dong_cd}
			</if>
			<if test="habitat_cd != null and !habitat_cd.equals('')">
				AND H.HABITAT_CD = #{habitat_cd}
			</if>
			<if test="habitat_nm != null and !habitat_nm.equals('')">
				AND H.HABITAT_NM like '%'|| #{habitat_nm} ||'%'
			</if>
		</where>
		ORDER BY H.HABITAT_CD DESC
	</select>
	
	<!-- 네비게이션 메뉴 목록 조회  -->
	<select id="selectMenuList" resultType="java.util.Map">
		SELECT M.MENU_NM
			, M.MENU_LINK
			, M.MENU_DESKTOP 
			, M.MENU_MOBILE
		FROM TB_MENU M
		ORDER BY M.MENU_ORDR
	</select>
	
	<!-- 네비게이션 모바일 etc 메뉴 목록 조회  -->
	<select id="selectEtcMenuList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT M.MENU_NM
			, M.MENU_LINK
			, M.MENU_DESKTOP 
			, M.MENU_MOBILE
		FROM TB_MENU M
		WHERE M.MENU_MOBILE = 'Y'
		ORDER BY M.MENU_ORDR
		OFFSET #{menuCount}
	</select>
	
	<!-- target 정보 조회 (고양이, 무리) -->
	<select id="selectCatMenuInfoList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT C.CAT_CD AS TARGET_CD
				, CASE WHEN GROUP_YN = 'Y' THEN 'grp' ELSE 'cat' END	AS TARGET_TYPE
		FROM TB_CAT C
			WHERE C.CAT_CD = #{target_cd}
	</select>
	
	<!-- target 정보 조회  -->
	<select id="selectTargetMenuInfoList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT #{target_cd}			AS TARGET_CD
				, #{target_type}	AS TARGET_TYPE
	</select>
	
	<!-- 서식지, 고양이 관리 사이드 네비게이션 메뉴 목록 조회 -->
	<select id="selectManageMenuList" parameterType="java.util.Map" resultType="java.util.Map">	
	WITH RECURSIVE SEARCH_MENU(MENU_ID, MENU_NM, MENU_UPPER_ID, MENU_LINK, MENU_DESKTOP, MENU_MOBILE, MENU_ORDR, level, MENU_PATH, cycle) as
	(
		SELECT	A.MENU_ID
				, A.MENU_NM
				, A.MENU_UPPER_ID 
				, A.MENU_LINK
				, A.MENU_DESKTOP
				, A.MENU_MOBILE
				, A.MENU_ORDR
				, 0
				, array[A.menu_id]
				, false
		FROM TB_MANAGE_MENU A
		WHERE A.TARGET_TYPE = #{target_type}
			AND A.MENU_UPPER_ID IS NULL
		
		UNION all
		
		/*하위 데이터를 찾아가기위한 반복조건 쿼리*/
	    SELECT A.MENU_ID
				, A.MENU_NM
				, A.MENU_UPPER_ID 
				, A.MENU_LINK
				, A.MENU_DESKTOP
				, A.MENU_MOBILE
				, A.MENU_ORDR 
            	, level+1
            	, MENU_PATH||A.MENU_ID
            	, A.MENU_ID = any(MENU_PATH)
	    FROM TB_MANAGE_MENU A, SEARCH_MENU S
	    WHERE A.MENU_UPPER_ID = S.MENU_ID 
	    	AND A.TARGET_TYPE =  #{target_type}
	    	AND NOT cycle
	)
	
	(
		SELECT M.MENU_ID
		        , lpad(' ',level) || M.MENU_NM AS MENU_NM 
		        , M.MENU_UPPER_ID 
		        , M.MENU_LINK
		        , m.level 
		        , M.MENU_PATH
		        , M.MENU_DESKTOP
		        , M.MENU_MOBILE
		FROM SEARCH_MENU M
		ORDER BY M.MENU_PATH
	)
	UNION ALL
	( 
		SELECT B.BOARD_ID 
				, B.BOARD_NM 
				, NULL
				, B.BOARD_LINK 
				, 1
				, NULL
		     	, 'Y'
		     	, 'Y'
		FROM TB_BOARD_MENU B
		WHERE B.TARGET_CD = #{target_cd}
			AND B.TARGET_TYPE = #{target_type}
		ORDER BY B.BOARD_ORDR
	)
	</select>
</mapper>